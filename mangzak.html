<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ë§ì‘ ë©”ì´ì»¤ ğŸ“–</title>
<link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
:root {
  --bg:#0C0A18; --card:#16142A; --card2:#1E1B35;
  --border:#2A2845; --text:#F0EAD6; --muted:#7A7490;
  --accent:#F5C518; --red:#E03535; --green:#22C55E;
  --spy:#E03535; --citizen:#3B82F6;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);
  font-family:'Noto Sans KR',sans-serif;overflow:hidden}

/* â”€â”€â”€ SCREENS â”€â”€â”€ */
.scr{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;
  overflow-y:auto;padding-bottom:40px;
  opacity:0;pointer-events:none;transition:opacity .35s;z-index:1}
.scr.on{opacity:1;pointer-events:all}

/* â”€â”€â”€ SETUP SCREEN â”€â”€â”€ */
#s-setup{justify-content:center;padding:24px}
.setup-box{background:var(--card);border:1px solid var(--border);border-radius:20px;
  padding:28px;max-width:480px;width:100%}
.setup-logo{font-family:'Black Han Sans';font-size:2rem;color:var(--accent);
  text-align:center;margin-bottom:4px}
.setup-sub{font-size:.8rem;color:var(--muted);text-align:center;margin-bottom:20px;line-height:1.6}
.setup-step{background:var(--card2);border-radius:12px;padding:14px 16px;
  margin-bottom:12px;font-size:.8rem;line-height:1.8}
.setup-step b{color:var(--accent)}
.setup-step code{background:#0C0A18;border-radius:4px;padding:1px 6px;
  font-size:.75rem;color:#88CFFF}
textarea.fb-input{width:100%;background:#0C0A18;border:1px solid var(--border);
  border-radius:10px;color:var(--text);padding:12px;font-size:.75rem;
  font-family:monospace;resize:vertical;min-height:130px;margin:12px 0;outline:none}
textarea.fb-input:focus{border-color:var(--accent)}

/* â”€â”€â”€ HOME SCREEN â”€â”€â”€ */
#s-home{justify-content:center;padding:24px;gap:20px}
.home-title{font-family:'Black Han Sans';font-size:3.2rem;color:var(--accent);
  text-align:center;line-height:1;text-shadow:0 0 40px rgba(245,197,24,.3)}
.home-subtitle{font-size:.85rem;color:var(--muted);text-align:center;line-height:1.7;
  max-width:280px}
.home-btns{display:flex;flex-direction:column;gap:10px;width:100%;max-width:320px}
.btn-primary{background:var(--accent);color:#0C0A18;font-family:'Black Han Sans';
  font-size:1.2rem;border:none;border-radius:14px;padding:16px;cursor:pointer;
  transition:transform .1s,filter .1s;letter-spacing:.05em}
.btn-primary:active{transform:scale(.96)}
.btn-secondary{background:var(--card);border:1.5px solid var(--border);color:var(--text);
  font-size:.95rem;font-weight:700;border-radius:14px;padding:14px;cursor:pointer;
  transition:border-color .2s}
.btn-secondary:hover{border-color:var(--accent)}
.name-input{background:var(--card2);border:1.5px solid var(--border);border-radius:12px;
  color:var(--text);font-size:1rem;padding:14px 16px;width:100%;outline:none;
  transition:border-color .2s;font-family:'Noto Sans KR'}
.name-input:focus{border-color:var(--accent)}
.join-row{display:flex;gap:8px}
.code-input{background:var(--card2);border:1.5px solid var(--border);border-radius:12px;
  color:var(--text);font-size:1.2rem;font-weight:700;letter-spacing:.2em;
  padding:14px 16px;flex:1;outline:none;text-transform:uppercase;font-family:monospace}
.code-input:focus{border-color:var(--accent)}
.divider{display:flex;align-items:center;gap:12px;color:var(--muted);font-size:.8rem;
  width:100%;max-width:320px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* â”€â”€â”€ LOBBY SCREEN â”€â”€â”€ */
#s-lobby{padding:24px}
.top-bar{display:flex;align-items:center;justify-content:space-between;
  width:100%;max-width:480px;margin-bottom:20px}
.back-btn{width:38px;height:38px;background:var(--card);border:1px solid var(--border);
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;cursor:pointer}
.screen-title{font-family:'Black Han Sans';font-size:1.4rem;color:var(--accent)}
.room-code-badge{background:var(--card2);border:1px solid var(--border);
  border-radius:20px;padding:6px 14px;font-size:.75rem;color:var(--muted)}
.room-code-badge b{color:var(--accent);font-size:.9rem;letter-spacing:.15em}

.player-list{width:100%;max-width:480px;display:flex;flex-direction:column;gap:8px;
  margin-bottom:20px}
.player-item{background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:12px 16px;display:flex;align-items:center;gap:12px}
.player-emoji{font-size:1.5rem;width:40px;height:40px;background:var(--card2);
  border-radius:50%;display:flex;align-items:center;justify-content:center}
.player-name{font-weight:700;flex:1}
.host-badge{font-size:.65rem;background:rgba(245,197,24,.15);color:var(--accent);
  border:1px solid rgba(245,197,24,.3);border-radius:20px;padding:2px 8px;font-weight:700}

.settings-box{width:100%;max-width:480px;background:var(--card);
  border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px}
.settings-title{font-size:.7rem;font-weight:700;color:var(--muted);
  letter-spacing:.15em;margin-bottom:14px}
.setting-row{display:flex;align-items:center;justify-content:space-between;
  margin-bottom:12px;gap:12px}
.setting-label{font-size:.85rem;color:var(--text)}
.setting-opts{display:flex;gap:6px}
.opt-btn{background:var(--card2);border:1.5px solid var(--border);border-radius:8px;
  color:var(--muted);font-size:.78rem;padding:5px 10px;cursor:pointer;transition:.15s;
  font-family:'Noto Sans KR'}
.opt-btn.on{background:rgba(245,197,24,.1);border-color:var(--accent);color:var(--accent)}

.start-btn{width:100%;max-width:480px;background:var(--accent);color:#0C0A18;
  font-family:'Black Han Sans';font-size:1.3rem;border:none;border-radius:14px;
  padding:17px;cursor:pointer}

/* â”€â”€â”€ ROLE SCREEN â”€â”€â”€ */
#s-role{justify-content:center;padding:24px;gap:24px}
.role-genre{font-size:.8rem;color:var(--muted);text-align:center;line-height:1.6}
.role-genre b{color:var(--text)}
.card-flip{width:280px;height:380px;perspective:1000px;cursor:pointer}
.card-inner{width:100%;height:100%;position:relative;
  transform-style:preserve-3d;transition:transform .8s cubic-bezier(.25,.46,.45,.94)}
.card-flip.flipped .card-inner{transform:rotateY(180deg)}
.card-face{position:absolute;inset:0;backface-visibility:hidden;border-radius:20px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;
  padding:28px}
.card-back{background:var(--card);border:2px solid var(--border)}
.card-back-pattern{font-size:2rem;opacity:.15;letter-spacing:.5rem;line-height:1.8;
  text-align:center;overflow:hidden;max-height:200px}
.card-back-label{font-family:'Black Han Sans';font-size:1.1rem;color:var(--muted)}
.card-front{background:var(--card);transform:rotateY(180deg)}
.card-front.citizen{border:2px solid var(--citizen);
  box-shadow:0 0 40px rgba(59,130,246,.2)}
.card-front.spy{border:2px solid var(--spy);
  box-shadow:0 0 40px rgba(224,53,53,.25);animation:spyGlow 2s ease-in-out infinite}
@keyframes spyGlow{0%,100%{box-shadow:0 0 30px rgba(224,53,53,.2)}
  50%{box-shadow:0 0 60px rgba(224,53,53,.4)}}
.role-icon{font-size:3.5rem}
.role-name{font-family:'Black Han Sans';font-size:1.8rem}
.citizen .role-name{color:var(--citizen)}
.spy .role-name{color:var(--spy)}
.role-desc{font-size:.8rem;color:var(--muted);text-align:center;line-height:1.7}
.mission-box{background:rgba(224,53,53,.1);border:1.5px solid rgba(224,53,53,.4);
  border-radius:12px;padding:14px;width:100%;text-align:center;margin-top:4px}
.mission-label{font-size:.65rem;color:var(--spy);font-weight:700;
  letter-spacing:.15em;margin-bottom:6px}
.mission-text{font-size:.85rem;color:var(--text);font-weight:700;line-height:1.6}
.mission-pts{font-size:.72rem;color:var(--accent);margin-top:4px}
.tap-hint{font-size:.75rem;color:var(--muted);animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}
.ok-btn{width:100%;max-width:320px;background:var(--accent);color:#0C0A18;
  font-family:'Black Han Sans';font-size:1.15rem;border:none;border-radius:14px;
  padding:16px;cursor:pointer;display:none}

/* â”€â”€â”€ GENRE SCREEN â”€â”€â”€ */
#s-genre{justify-content:center;padding:32px 24px;gap:20px}
.genre-pill{background:rgba(245,197,24,.1);border:1px solid rgba(245,197,24,.3);
  border-radius:999px;padding:6px 18px;font-size:.8rem;color:var(--accent);
  font-weight:700;letter-spacing:.1em}
.genre-title{font-family:'Black Han Sans';font-size:2.2rem;color:var(--text);
  text-align:center;line-height:1.2}
.genre-emoji{font-size:4rem}
.opening-box{background:var(--card);border-left:3px solid var(--accent);
  border-radius:0 12px 12px 0;padding:18px 20px;width:100%;max-width:420px;
  font-family:'Nanum Myeongjo';font-size:1.05rem;line-height:1.9;color:var(--text)}
.goal-box{background:var(--card2);border:1px solid var(--border);border-radius:12px;
  padding:14px 18px;width:100%;max-width:420px;font-size:.82rem;
  color:var(--muted);line-height:1.7}
.goal-box b{color:var(--text)}

/* â”€â”€â”€ WRITING SCREEN â”€â”€â”€ */
#s-writing{padding:16px}
.writing-header{width:100%;max-width:480px;margin-bottom:16px}
.turn-indicator{text-align:center;margin-bottom:8px}
.turn-name{font-family:'Black Han Sans';font-size:1.2rem;color:var(--accent)}
.turn-sub{font-size:.75rem;color:var(--muted);margin-top:2px}
.progress-bar-wrap{width:100%;height:4px;background:var(--border);border-radius:2px;
  margin-top:10px}
.progress-bar{height:100%;background:var(--accent);border-radius:2px;
  transition:width .3s}

.view-box{background:var(--card);border:1px solid var(--border);border-radius:14px;
  padding:20px;width:100%;max-width:480px;margin-bottom:12px;
  font-family:'Nanum Myeongjo';font-size:1.05rem;line-height:2;
  color:var(--muted);min-height:80px;position:relative}
.view-box .visible-text{color:var(--text)}
.view-label{font-size:.65rem;color:var(--muted);letter-spacing:.15em;
  font-weight:700;margin-bottom:8px;font-family:'Noto Sans KR'}

.timer-ring{width:60px;height:60px;position:relative;margin:0 auto 10px}
.timer-ring svg{transform:rotate(-90deg)}
.timer-ring circle{fill:none;stroke:var(--border);stroke-width:4}
.timer-ring circle.prog{stroke:var(--accent);stroke-width:4;
  stroke-dasharray:157;stroke-linecap:round;transition:stroke-dashoffset .9s linear,stroke .5s}
.timer-ring .timer-num{position:absolute;inset:0;display:flex;align-items:center;
  justify-content:center;font-family:'Black Han Sans';font-size:1.3rem;color:var(--accent)}

.write-input{width:100%;max-width:480px;background:var(--card);
  border:2px solid var(--accent);border-radius:14px;color:var(--text);
  font-family:'Nanum Myeongjo';font-size:1.05rem;padding:16px;
  resize:none;outline:none;min-height:110px;line-height:1.8}
.char-count{font-size:.75rem;color:var(--muted);text-align:right;
  width:100%;max-width:480px;margin-top:4px}
.submit-sentence-btn{width:100%;max-width:480px;background:var(--accent);
  color:#0C0A18;font-family:'Black Han Sans';font-size:1.2rem;
  border:none;border-radius:14px;padding:16px;cursor:pointer;margin-top:8px}
.submit-sentence-btn:disabled{opacity:.4;cursor:not-allowed}

.waiting-screen{display:flex;flex-direction:column;align-items:center;
  justify-content:center;min-height:60vh;gap:16px;padding:24px;text-align:center}
.waiting-spinner{width:60px;height:60px;border:3px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.waiting-name{font-family:'Black Han Sans';font-size:1.5rem;color:var(--accent)}
.waiting-sub{font-size:.85rem;color:var(--muted);line-height:1.7}

/* â”€â”€â”€ NARRATION SCREEN â”€â”€â”€ */
#s-narration{padding:24px}
.narration-header{width:100%;max-width:540px;text-align:center;margin-bottom:20px}
.story-title{font-family:'Black Han Sans';font-size:1.6rem;color:var(--accent);
  margin-bottom:4px}
.story-meta{font-size:.75rem;color:var(--muted)}
.tts-controls{display:flex;gap:8px;margin-bottom:20px;width:100%;max-width:540px}
.tts-btn{flex:1;background:var(--card);border:1.5px solid var(--border);
  border-radius:12px;padding:10px;font-size:.82rem;font-weight:700;
  color:var(--text);cursor:pointer;transition:.15s;font-family:'Noto Sans KR'}
.tts-btn:hover{border-color:var(--accent);color:var(--accent)}
.tts-btn.playing{background:rgba(245,197,24,.1);border-color:var(--accent);
  color:var(--accent)}

.story-scroll{width:100%;max-width:540px;display:flex;flex-direction:column;gap:12px;
  margin-bottom:24px}
.sentence-card{background:var(--card);border-left:3px solid var(--border);
  border-radius:0 12px 12px 0;padding:16px 18px;
  transition:border-color .3s,background .3s}
.sentence-card.speaking{border-left-color:var(--accent);
  background:rgba(245,197,24,.05)}
.sentence-text{font-family:'Nanum Myeongjo';font-size:1.05rem;
  line-height:2;color:var(--text);margin-bottom:6px}
.sentence-author{font-size:.72rem;color:var(--muted);text-align:right}

.next-phase-btn{width:100%;max-width:540px;background:var(--accent);color:#0C0A18;
  font-family:'Black Han Sans';font-size:1.2rem;border:none;border-radius:14px;
  padding:16px;cursor:pointer}

/* â”€â”€â”€ VOTE1 SCREEN â”€â”€â”€ */
#s-vote1{padding:24px}
.vote-header{width:100%;max-width:480px;margin-bottom:20px;text-align:center}
.vote-title{font-family:'Black Han Sans';font-size:1.6rem;color:var(--text);
  margin-bottom:6px}
.vote-sub{font-size:.82rem;color:var(--muted);line-height:1.7}
.vote-list{width:100%;max-width:480px;display:flex;flex-direction:column;gap:8px;
  margin-bottom:20px}
.vote-item{background:var(--card);border:2px solid var(--border);border-radius:14px;
  padding:14px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;
  transition:.2s}
.vote-item:hover{border-color:var(--muted)}
.vote-item.selected{border-color:var(--red);background:rgba(224,53,53,.08)}
.vote-item-emoji{font-size:1.6rem}
.vote-item-name{font-weight:700;flex:1}
.vote-item-check{font-size:1.3rem}
.submit-vote-btn{width:100%;max-width:480px;background:var(--red);color:#fff;
  font-family:'Black Han Sans';font-size:1.2rem;border:none;border-radius:14px;
  padding:16px;cursor:pointer}
.submit-vote-btn:disabled{opacity:.4;cursor:not-allowed}
.vote-status{width:100%;max-width:480px;text-align:center;
  font-size:.8rem;color:var(--muted);margin-top:12px}

/* â”€â”€â”€ DEFENSE SCREEN â”€â”€â”€ */
#s-defense{justify-content:center;padding:24px;gap:16px}
.defense-icon{font-size:3.5rem;text-align:center}
.defense-name{font-family:'Black Han Sans';font-size:1.8rem;color:var(--red);
  text-align:center}
.defense-prompt{font-size:.85rem;color:var(--muted);text-align:center;
  line-height:1.7;max-width:340px}
.defense-input{width:100%;max-width:440px;background:var(--card);
  border:2px solid var(--border);border-radius:14px;color:var(--text);
  font-family:'Nanum Myeongjo';font-size:1rem;padding:16px;
  resize:none;outline:none;min-height:100px;line-height:1.8}
.defense-input:focus{border-color:var(--red)}
.defense-speech{width:100%;max-width:440px;background:var(--card);
  border:2px solid var(--border);border-radius:14px;padding:18px;
  font-family:'Nanum Myeongjo';font-size:1rem;line-height:1.9;
  color:var(--text);min-height:80px}
.submit-defense-btn{width:100%;max-width:440px;background:var(--red);color:#fff;
  font-family:'Black Han Sans';font-size:1.2rem;border:none;
  border-radius:14px;padding:16px;cursor:pointer}

/* â”€â”€â”€ VOTE2 SCREEN â”€â”€â”€ */
#s-vote2{justify-content:center;padding:24px;gap:20px}
.verdict-q{font-family:'Black Han Sans';font-size:1.5rem;color:var(--text);
  text-align:center;line-height:1.4}
.accused-card{background:var(--card);border:2px solid var(--red);border-radius:16px;
  padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px;
  width:100%;max-width:320px}
.accused-emoji{font-size:2.5rem}
.accused-name{font-family:'Black Han Sans';font-size:1.4rem}
.defense-preview{font-size:.8rem;color:var(--muted);text-align:center;
  line-height:1.7;font-family:'Nanum Myeongjo';max-height:80px;overflow:hidden}
.verdict-btns{display:flex;gap:12px;width:100%;max-width:320px}
.execute-btn{flex:1;background:var(--red);color:#fff;font-family:'Black Han Sans';
  font-size:1.1rem;border:none;border-radius:14px;padding:16px;cursor:pointer}
.acquit-btn{flex:1;background:var(--card);border:2px solid var(--border);
  color:var(--text);font-family:'Black Han Sans';font-size:1.1rem;
  border:none;border-radius:14px;padding:16px;cursor:pointer}
.voted-waiting{font-size:.8rem;color:var(--muted);text-align:center}

/* â”€â”€â”€ RESULT SCREEN â”€â”€â”€ */
#s-result{padding:24px}
.result-header{width:100%;max-width:520px;text-align:center;margin-bottom:24px}
.result-headline{font-family:'Black Han Sans';font-size:1.4rem;color:var(--accent)}

.reveal-card{width:100%;max-width:520px;background:var(--card);
  border-radius:20px;padding:24px;margin-bottom:16px;text-align:center;
  border:2px solid var(--border)}
.reveal-card.spy-won{border-color:var(--spy);
  box-shadow:0 0 40px rgba(224,53,53,.2)}
.reveal-card.citizens-won{border-color:var(--citizen);
  box-shadow:0 0 40px rgba(59,130,246,.15)}
.spy-reveal-emoji{font-size:3rem;margin-bottom:8px}
.spy-reveal-role{font-family:'Black Han Sans';font-size:1.1rem;
  color:var(--spy);margin-bottom:4px}
.spy-reveal-name{font-family:'Black Han Sans';font-size:2rem;margin-bottom:12px}
.mission-result-box{background:rgba(224,53,53,.1);border:1px solid rgba(224,53,53,.3);
  border-radius:12px;padding:14px;margin-bottom:8px}
.mission-result-label{font-size:.7rem;color:var(--spy);font-weight:700;
  letter-spacing:.15em;margin-bottom:6px}
.mission-result-text{font-size:.88rem;color:var(--text);line-height:1.6}
.mission-result-status{font-size:.82rem;font-weight:700;margin-top:8px}
.mission-result-status.success{color:var(--green)}
.mission-result-status.fail{color:var(--muted)}

.scores-box{width:100%;max-width:520px;display:flex;flex-direction:column;
  gap:6px;margin-bottom:16px}
.score-row{background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:12px 18px;display:flex;align-items:center;gap:12px}
.score-row:first-child{border-color:var(--accent)}
.score-emoji{font-size:1.5rem}
.score-name{font-weight:700;flex:1}
.score-pts{font-family:'Black Han Sans';font-size:1.3rem;color:var(--accent)}
.score-change{font-size:.75rem;color:var(--green);margin-left:4px}

.ai-box{width:100%;max-width:520px;background:var(--card2);
  border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px}
.ai-label{font-size:.65rem;color:var(--muted);letter-spacing:.15em;
  font-weight:700;margin-bottom:10px}
.ai-text{font-family:'Nanum Myeongjo';font-size:.95rem;line-height:1.9;
  color:var(--text)}

.replay-btn{width:100%;max-width:520px;background:var(--accent);color:#0C0A18;
  font-family:'Black Han Sans';font-size:1.2rem;border:none;
  border-radius:14px;padding:16px;cursor:pointer;margin-bottom:8px}
.home-again-btn{width:100%;max-width:520px;background:var(--card);
  border:1.5px solid var(--border);color:var(--text);font-weight:700;
  font-size:.95rem;border-radius:14px;padding:14px;cursor:pointer;
  font-family:'Noto Sans KR'}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);
  background:#2A2845;border:1px solid var(--border);border-radius:12px;
  padding:12px 20px;font-size:.85rem;color:var(--text);
  z-index:999;opacity:0;transition:opacity .3s;pointer-events:none;
  white-space:nowrap;max-width:90vw}
.toast.show{opacity:1}

/* â”€â”€â”€ MISC â”€â”€â”€ */
.gap4{display:flex;flex-direction:column;gap:4px}
.full-w{width:100%;max-width:480px}
.mt8{margin-top:8px}
.hidden{display:none!important}

.emoji-select{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;
  width:100%;max-width:380px}
.emoji-opt{font-size:1.8rem;width:52px;height:52px;background:var(--card2);
  border:2px solid var(--border);border-radius:12px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:.15s}
.emoji-opt.selected{border-color:var(--accent);background:rgba(245,197,24,.1)}

@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.fade-up{animation:fadeUp .4s ease forwards}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â• SETUP SCREEN â•â•â•â•â•â• -->
<div id="s-setup" class="scr">
  <div class="setup-box">
    <div class="setup-logo">ë§ì‘ ë©”ì´ì»¤</div>
    <div class="setup-sub">ë©€í‹°í”Œë ˆì´ë¥¼ ìœ„í•´ Firebase ì„¤ì •ì´ í•„ìš”í•´ìš”<br>ë”± í•œ ë²ˆë§Œ í•˜ë©´ ë¼ìš”! (5ë¶„ì´ë©´ ì¶©ë¶„)</div>
    <div class="setup-step">
      <b>â‘  Firebase ì½˜ì†”</b> â†’ <a href="https://console.firebase.google.com" target="_blank" style="color:#88CFFF">console.firebase.google.com</a><br>
      â†’ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸° â†’ <b>Realtime Database</b> í™œì„±í™” (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
    </div>
    <div class="setup-step">
      <b>â‘¡ í”„ë¡œì íŠ¸ ì„¤ì •</b> (âš™ï¸ ì•„ì´ì½˜) â†’ ë‚´ ì•± ì¶”ê°€ (ì›¹ <code>&lt;/&gt;</code>)<br>
      â†’ ì•„ë˜ <code>firebaseConfig</code> ê°ì²´ë¥¼ ë³µì‚¬í•´ ë¶™ì—¬ë„£ê¸°
    </div>
    <textarea class="fb-input" id="fbConfigInput" placeholder='{
  "apiKey": "...",
  "authDomain": "...",
  "databaseURL": "https://...",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}'></textarea>
    <button class="btn-primary" onclick="initFirebase()">ğŸ”¥ Firebase ì—°ê²°í•˜ê¸°</button>
    <div id="fbError" style="color:var(--red);font-size:.78rem;margin-top:8px;text-align:center"></div>
  </div>
</div>

<!-- â•â•â•â•â•â• HOME SCREEN â•â•â•â•â•â• -->
<div id="s-home" class="scr">
  <div class="home-title">ë§ì‘<br>ë©”ì´ì»¤</div>
  <div class="home-subtitle">ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ì“°ëŠ” ë¦´ë ˆì´ ì†Œì„¤<br>ëˆ„ê°€ ì´ì•¼ê¸°ë¥¼ ë§ì¹˜ê³  ìˆì„ê¹Œ? ğŸ“–</div>
  
  <div class="home-btns">
    <div class="gap4">
      <label style="font-size:.75rem;color:var(--muted);letter-spacing:.1em">ë‚´ ë‹‰ë„¤ì„</label>
      <input class="name-input" id="myName" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
    </div>
    <div style="font-size:.75rem;color:var(--muted);margin:-4px 0 -4px">
      ì´ëª¨ì§€ ì„ íƒ:
    </div>
    <div class="emoji-select" id="emojiSelect">
      <div class="emoji-opt selected" data-e="ğŸ“" onclick="selectEmoji(this)">ğŸ“</div>
      <div class="emoji-opt" data-e="ğŸ­" onclick="selectEmoji(this)">ğŸ­</div>
      <div class="emoji-opt" data-e="ğŸ¦Š" onclick="selectEmoji(this)">ğŸ¦Š</div>
      <div class="emoji-opt" data-e="ğŸ¸" onclick="selectEmoji(this)">ğŸ¸</div>
      <div class="emoji-opt" data-e="ğŸ™" onclick="selectEmoji(this)">ğŸ™</div>
      <div class="emoji-opt" data-e="ğŸ±" onclick="selectEmoji(this)">ğŸ±</div>
      <div class="emoji-opt" data-e="ğŸ»" onclick="selectEmoji(this)">ğŸ»</div>
      <div class="emoji-opt" data-e="ğŸŒš" onclick="selectEmoji(this)">ğŸŒš</div>
    </div>
    <button class="btn-primary" onclick="createRoom()">ğŸ“– ë°© ë§Œë“¤ê¸°</button>
    <div class="divider">ë˜ëŠ”</div>
    <div class="join-row">
      <input class="code-input" id="joinCode" placeholder="ë°© ì½”ë“œ" maxlength="6">
      <button class="btn-primary" style="width:80px;padding:14px 0;font-size:1rem" onclick="joinRoom()">ì…ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• LOBBY SCREEN â•â•â•â•â•â• -->
<div id="s-lobby" class="scr">
  <div class="top-bar">
    <div class="back-btn" onclick="leaveRoom()">â†</div>
    <div class="screen-title">ëŒ€ê¸°ì‹¤</div>
    <div class="room-code-badge">ì½”ë“œ <b id="lobbyCode">---</b></div>
  </div>

  <div class="player-list" id="playerList"></div>

  <div class="settings-box" id="settingsBox">
    <div class="settings-title">ê²Œì„ ì„¤ì •</div>
    <div class="setting-row">
      <div class="setting-label">1ì¸ë‹¹ í„´ ìˆ˜</div>
      <div class="setting-opts">
        <div class="opt-btn on" data-k="turns" data-v="2" onclick="setSetting(this)">2íšŒ</div>
        <div class="opt-btn" data-k="turns" data-v="3" onclick="setSetting(this)">3íšŒ</div>
        <div class="opt-btn" data-k="turns" data-v="4" onclick="setSetting(this)">4íšŒ</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">ì œí•œ ì‹œê°„</div>
      <div class="setting-opts">
        <div class="opt-btn" data-k="timer" data-v="30" onclick="setSetting(this)">30ì´ˆ</div>
        <div class="opt-btn on" data-k="timer" data-v="60" onclick="setSetting(this)">60ì´ˆ</div>
        <div class="opt-btn" data-k="timer" data-v="0" onclick="setSetting(this)">ì—†ìŒ</div>
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">ì‹œì•¼ ì œí•œ</div>
      <div class="setting-opts">
        <div class="opt-btn on" data-k="view" data-v="sentence" onclick="setSetting(this)">1ë¬¸ì¥</div>
        <div class="opt-btn" data-k="view" data-v="chars" onclick="setSetting(this)">15ê¸€ì</div>
        <div class="opt-btn" data-k="view" data-v="full" onclick="setSetting(this)">ì „ì²´</div>
      </div>
    </div>
  </div>

  <button class="start-btn" id="startBtn" onclick="startGame()">ğŸ² ê²Œì„ ì‹œì‘!</button>
  <div id="waitingForHost" class="hidden" style="font-size:.85rem;color:var(--muted);text-align:center;margin-top:16px">
    ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...
  </div>
</div>

<!-- â•â•â•â•â•â• ROLE SCREEN â•â•â•â•â•â• -->
<div id="s-role" class="scr">
  <div class="role-genre">
    <b>ì´ë²ˆ ë¼ìš´ë“œ ì¥ë¥´</b><br>
    <span id="roleGenreName"></span>
  </div>
  <div style="font-size:.8rem;color:var(--muted)">ì¹´ë“œë¥¼ íƒ­í•´ì„œ ì—­í• ì„ í™•ì¸í•˜ì„¸ìš”</div>
  <div class="card-flip" id="roleCard" onclick="flipCard()">
    <div class="card-inner">
      <div class="card-face card-back">
        <div class="card-back-pattern">ğŸ“–ğŸ“–ğŸ“–<br>ğŸ“–ğŸ“–ğŸ“–<br>ğŸ“–ğŸ“–ğŸ“–<br>ğŸ“–ğŸ“–ğŸ“–<br>ğŸ“–ğŸ“–ğŸ“–</div>
        <div class="card-back-label">íƒ­í•´ì„œ ì—­í•  í™•ì¸</div>
      </div>
      <div class="card-face card-front" id="cardFront">
        <div class="role-icon" id="roleIcon">?</div>
        <div class="role-name" id="roleName">?</div>
        <div class="role-desc" id="roleDesc"></div>
        <div class="mission-box" id="missionBox" style="display:none">
          <div class="mission-label">ğŸ•µï¸ ë¹„ë°€ ë¯¸ì…˜</div>
          <div class="mission-text" id="missionText"></div>
          <div class="mission-pts" id="missionPts"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="tap-hint" id="tapHint">â–² ì¹´ë“œë¥¼ íƒ­í•˜ì„¸ìš”</div>
  <button class="ok-btn" id="roleOkBtn" onclick="confirmRole()">âœ… ì—­í•  í™•ì¸ ì™„ë£Œ!</button>
  <div style="font-size:.78rem;color:var(--muted)" id="roleWaiting"></div>
</div>

<!-- â•â•â•â•â•â• GENRE SCREEN â•â•â•â•â•â• -->
<div id="s-genre" class="scr">
  <div class="genre-pill" id="genrePill">ì¥ë¥´</div>
  <div class="genre-emoji" id="genreEmoji">ğŸ“–</div>
  <div class="genre-title" id="genreTitle">ì´ë²ˆ ë¼ìš´ë“œì˜ ì¥ë¥´</div>
  <div class="opening-box" id="openingBox"></div>
  <div class="goal-box" id="goalBox"></div>
  <button class="start-btn" id="genreStartBtn" style="width:100%;max-width:420px;margin-top:8px" onclick="beginWriting()">âœï¸ ì§‘í•„ ì‹œì‘!</button>
</div>

<!-- â•â•â•â•â•â• WRITING SCREEN â•â•â•â•â•â• -->
<div id="s-writing" class="scr">
  <!-- Your turn view -->
  <div id="myTurnView" style="width:100%;max-width:480px;display:flex;flex-direction:column;align-items:center;gap:10px">
    <div class="writing-header">
      <div class="turn-indicator">
        <div class="turn-name">âœï¸ ë‚´ ì°¨ë¡€!</div>
        <div class="turn-sub" id="writingTurnSub">ë¬¸ì¥ì„ ì´ì–´ ì¨ì£¼ì„¸ìš”</div>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar" id="writingProgress" style="width:0%"></div>
      </div>
    </div>

    <div class="view-box">
      <div class="view-label" id="viewModeLabel">ë§ˆì§€ë§‰ ë¬¸ì¥</div>
      <div class="visible-text" id="limitedView"></div>
    </div>

    <div class="timer-ring" id="timerRing">
      <svg width="60" height="60" viewBox="0 0 60 60">
        <circle cx="30" cy="30" r="25"/>
        <circle class="prog" cx="30" cy="30" r="25" id="timerCircle"/>
      </svg>
      <div class="timer-num" id="timerNum">â€”</div>
    </div>

    <textarea class="write-input" id="writeInput" placeholder="ì—¬ê¸°ì— ì´ì•¼ê¸°ë¥¼ ì´ì–´ ì“°ì„¸ìš”..."
      maxlength="150" oninput="updateCharCount()"></textarea>
    <div class="char-count"><span id="charCount">0</span> / 150ì</div>
    <button class="submit-sentence-btn" id="submitBtn" onclick="submitSentence()">ì´ ë¬¸ì¥ ì œì¶œ â†’</button>
  </div>

  <!-- Waiting view -->
  <div id="waitingView" class="waiting-screen" style="display:none">
    <div class="waiting-spinner"></div>
    <div class="waiting-name" id="waitingName">ëˆ„êµ°ê°€ì˜ ì°¨ë¡€</div>
    <div class="waiting-sub">ì´ì•¼ê¸°ë¥¼ ì“°ê³  ìˆì–´ìš”...<br>ëë‚˜ë©´ ìë™ìœ¼ë¡œ ë„˜ì–´ê°€ìš”</div>
    <div class="timer-ring" id="waitTimerRing">
      <svg width="60" height="60" viewBox="0 0 60 60">
        <circle cx="30" cy="30" r="25"/>
        <circle class="prog" cx="30" cy="30" r="25" id="waitTimerCircle"/>
      </svg>
      <div class="timer-num" id="waitTimerNum">â€”</div>
    </div>
    <div class="progress-bar-wrap" style="width:220px">
      <div class="progress-bar" id="waitProgress" style="width:0%"></div>
    </div>
    <div style="font-size:.78rem;color:var(--muted)" id="waitTurnInfo"></div>
  </div>
</div>

<!-- â•â•â•â•â•â• NARRATION SCREEN â•â•â•â•â•â• -->
<div id="s-narration" class="scr">
  <div class="narration-header">
    <div class="story-title" id="storyTitleDisplay">ì™„ì„±ëœ ë§ì‘</div>
    <div class="story-meta" id="storyMeta"></div>
  </div>
  <div class="tts-controls">
    <button class="tts-btn" id="ttsPlayBtn" onclick="startTTS()">ğŸ”Š ë‚­ë… ì‹œì‘</button>
    <button class="tts-btn" onclick="stopTTS()">â¹ ì •ì§€</button>
  </div>
  <div class="story-scroll" id="storyScroll"></div>
  <button class="next-phase-btn" id="goVoteBtn" onclick="goToVote()">ğŸ—³ ìŠ¤íŒŒì´ë¥¼ ì°¾ì•„ë¼!</button>
</div>

<!-- â•â•â•â•â•â• VOTE1 SCREEN â•â•â•â•â•â• -->
<div id="s-vote1" class="scr">
  <div class="vote-header">
    <div class="vote-title">ğŸ•µï¸ ìŠ¤íŒŒì´ ì§€ëª©</div>
    <div class="vote-sub">ì´ì•¼ê¸°ë¥¼ ë§ì¹œ ìŠ¤íŒŒì´ê°€ ëˆ„êµ¬ì¼ê¹Œìš”?<br>ê°€ì¥ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì‚¬ëŒì„ ê³¨ë¼ì£¼ì„¸ìš”</div>
  </div>
  <div class="vote-list" id="voteList"></div>
  <button class="submit-vote-btn" id="submitVoteBtn" disabled onclick="submitVote1()">ì§€ëª© ì™„ë£Œ</button>
  <div class="vote-status" id="vote1Status"></div>
</div>

<!-- â•â•â•â•â•â• DEFENSE SCREEN â•â•â•â•â•â• -->
<div id="s-defense" class="scr">
  <div class="defense-icon">âš–ï¸</div>
  <div class="defense-name" id="accusedName">í”¼ê³ ì¸</div>
  <div class="defense-prompt" id="defensPrompt">
    ë‹¹ì‹ ì´ ì§€ëª©ì„ ê°€ì¥ ë§ì´ ë°›ì•˜ìŠµë‹ˆë‹¤.<br>30ì´ˆ ì•ˆì— ì–µìš¸í•¨ì„ í˜¸ì†Œí•˜ì„¸ìš”!
  </div>
  <div class="timer-ring">
    <svg width="60" height="60" viewBox="0 0 60 60">
      <circle cx="30" cy="30" r="25"/>
      <circle class="prog" cx="30" cy="30" r="25" id="defenseTimer"/>
    </svg>
    <div class="timer-num" id="defenseTimerNum">30</div>
  </div>
  <textarea class="defense-input" id="defenseInput" maxlength="200"
    placeholder="ë‚˜ëŠ” ìŠ¤íŒŒì´ê°€ ì•„ë‹™ë‹ˆë‹¤! ì™œëƒí•˜ë©´..."></textarea>
  <div class="defense-speech" id="defenseSpeech" style="display:none"></div>
  <button class="submit-defense-btn" id="submitDefenseBtn" onclick="submitDefense()">ë³€ë¡  ì™„ë£Œ</button>
  <div style="font-size:.8rem;color:var(--muted);text-align:center" id="defenseWaiting"></div>
</div>

<!-- â•â•â•â•â•â• VOTE2 SCREEN â•â•â•â•â•â• -->
<div id="s-vote2" class="scr">
  <div class="verdict-q">ê³¼ì—° <span id="accusedInVote2"></span>ì€<br>ìŠ¤íŒŒì´ì¼ê¹Œìš”?</div>
  <div class="accused-card">
    <div class="accused-emoji" id="accusedEmoji2">ğŸ­</div>
    <div class="accused-name" id="accusedName2">???</div>
    <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px">ìµœí›„ ë³€ë¡ </div>
    <div class="defense-preview" id="defensePreview2">â€”</div>
  </div>
  <div class="verdict-btns">
    <button class="execute-btn" onclick="submitVote2('execute')">ğŸ—¡ ì²˜í˜•!</button>
    <button class="acquit-btn" onclick="submitVote2('acquit')">ğŸ•Š ë¬´ì£„!</button>
  </div>
  <div class="voted-waiting" id="vote2Status"></div>
</div>

<!-- â•â•â•â•â•â• RESULT SCREEN â•â•â•â•â•â• -->
<div id="s-result" class="scr">
  <div class="result-header">
    <div class="result-headline" id="resultHeadline">ê²°ê³¼ ë°œí‘œ</div>
  </div>
  <div class="reveal-card" id="revealCard">
    <div class="spy-reveal-emoji" id="spyRevealEmoji">ğŸ•µï¸</div>
    <div class="spy-reveal-role">ìŠ¤íŒŒì´ëŠ”...</div>
    <div class="spy-reveal-name" id="spyRevealName"></div>
    <div class="mission-result-box">
      <div class="mission-result-label">ë¹„ë°€ ë¯¸ì…˜</div>
      <div class="mission-result-text" id="missionRevealText"></div>
      <div class="mission-result-status" id="missionStatus"></div>
    </div>
  </div>
  <div class="scores-box" id="scoresBox"></div>
  <div class="ai-box">
    <div class="ai-label">ğŸ™ AI ë¬¸í•™ í‰ë¡ ê°€ì˜ í•œë§ˆë””</div>
    <div class="ai-text" id="aiCommentary">ë¶„ì„ ì¤‘...</div>
  </div>
  <button class="replay-btn" id="replayBtn" onclick="replayGame()">ğŸ”„ ê°™ì€ ë©¤ë²„ë¡œ í•œ íŒ ë”!</button>
  <button class="home-again-btn" onclick="goHomeFromResult()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA: MISSIONS & GENRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MISSIONS = {
  easy: [
    {text:'"êµ­ë°¥"ì„ 2ë²ˆ ì´ìƒ ìì—°ìŠ¤ëŸ½ê²Œ ë“±ì¥ì‹œí‚¤ê¸°',pts:1},
    {text:'ì£¼ì¸ê³µì´ ëˆˆë¬¼ì„ í˜ë¦¬ê²Œ ë§Œë“¤ê¸°',pts:1},
    {text:'ë™ë¬¼ì´ í•œ ë§ˆë¦¬ ì´ìƒ ë“±ì¥í•˜ê²Œ í•˜ê¸°',pts:1},
    {text:'ê°‘ìê¸° ë‚ ì”¨ë¥¼ ê¸‰ë³€ì‹œí‚¤ê¸° (ë§‘ìŒâ†’í­í’ ë“±)',pts:1},
    {text:'ì „í™” í†µí™” ì¥ë©´ì„ ë„£ê¸°',pts:1},
    {text:'"ì¹˜í‚¨"ì´ 1ë²ˆ ì´ìƒ ìì—°ìŠ¤ëŸ½ê²Œ ë“±ì¥í•˜ê²Œ í•˜ê¸°',pts:1},
    {text:'ìƒˆë¡œìš´ ë“±ì¥ì¸ë¬¼ì„ ê°‘ìê¸° ì¶”ê°€í•˜ê¸°',pts:1},
    {text:'ì‹ì‚¬ ì¥ë©´ì„ 1ë²ˆ ì´ìƒ ë„£ê¸°',pts:1},
    {text:'ëˆ„êµ°ê°€ ë„˜ì–´ì§€ê±°ë‚˜ ë‹¤ì¹˜ê²Œ í•˜ê¸°',pts:1},
    {text:'"ì‚¬ì‹¤ì€..."ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë°˜ì „ì„ ì•”ì‹œí•˜ê¸°',pts:1},
    {text:'"ë¼ë©´"ì´ 2ë²ˆ ì´ìƒ ìì—°ìŠ¤ëŸ½ê²Œ ë“±ì¥í•˜ê²Œ í•˜ê¸°',pts:1},
    {text:'ì£¼ì¸ê³µì´ ë­”ê°€ë¥¼ ê°‘ìê¸° ê±°ì ˆí•˜ê²Œ ë§Œë“¤ê¸°',pts:1},
    {text:'ì£¼ì¸ê³µì´ ë­”ê°€ë¥¼ ì¶©ë™êµ¬ë§¤í•˜ê²Œ ë§Œë“¤ê¸°',pts:1},
    {text:'ë…¸ë˜ë‚˜ ì½§ë…¸ë˜ê°€ ë“±ì¥í•˜ê²Œ í•˜ê¸°',pts:1},
    {text:'ì£¼ì¸ê³µì´ ê¸¸ì„ ìƒê²Œ ë§Œë“¤ê¸°',pts:1},
    {text:'ë“±ì¥ì¸ë¬¼ì´ í•¸ë“œí°ì„ ë¶„ì‹¤í•˜ê²Œ í•˜ê¸°',pts:1},
    {text:'ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì¬íšŒ ì¥ë©´ì„ ë§Œë“¤ê¸°',pts:1},
    {text:'"ì»¤í”¼"ê°€ 2ë²ˆ ì´ìƒ ë“±ì¥í•˜ê²Œ í•˜ê¸°',pts:1},
  ],
  medium: [
    {text:'ì£¼ì¸ê³µì´ ì‚¬ì‹¤ ì™¸ê³„ì¸ì„ì„ ì•”ì‹œí•˜ê¸°',pts:2},
    {text:'"ì‚¬ì‹¤ ì´ ëª¨ë“  ê±´ ê¿ˆì´ì—ˆë‹¤" ê²°ë§ë¡œ ìœ ë„í•˜ê¸°',pts:2},
    {text:'ì£¼ì¸ê³µì´ ì‹œê°„ ì—¬í–‰ìì„ì„ ì•”ì‹œí•˜ê¸°',pts:2},
    {text:'ë¡œë§¨ìŠ¤ê°€ ê°‘ìê¸° ìš”ë¦¬ ëŒ€ê²°ë¡œ ì „í™˜ë˜ê²Œ í•˜ê¸°',pts:2},
    {text:'ì£¼ì¸ê³µì´ ê°‘ìê¸° ì™¸êµ­ìœ¼ë¡œ ë– ë‚˜ê²Œ í•˜ê¸°',pts:2},
    {text:'ì•…ë‹¹ì´ ì‚¬ì‹¤ ì°©í•œ ì‚¬ëŒì´ì—ˆë‹¤ëŠ” ë°˜ì „ ì‹¬ê¸°',pts:2},
    {text:'"ê³ ì–‘ì´"ê°€ ì´ì•¼ê¸°ì˜ í•µì‹¬ ì—´ì‡ ê°€ ë˜ê²Œ í•˜ê¸°',pts:2},
    {text:'ì£¼ì¸ê³µì´ ê¸°ì–µì„ ìƒê²Œ ë§Œë“¤ê¸°',pts:2},
    {text:'ì´ì•¼ê¸° ë¶„ìœ„ê¸°ë¥¼ ê°‘ìê¸° ê³µí¬ë¬¼ë¡œ ê¸‰ì „í™˜í•˜ê¸°',pts:2},
    {text:'ì£¼ì¸ê³µì´ ì‚¬ì‹¤ ë¡œë´‡ì„ì„ ì•”ì‹œí•˜ê¸°',pts:2},
    {text:'"ëˆê¹ŒìŠ¤"ê°€ ì´ì•¼ê¸°ì˜ í•µì‹¬ ì†Œì¬ê°€ ë˜ê²Œ í•˜ê¸°',pts:2},
    {text:'ì£¼ì¸ê³µì´ ì‚¬ì‹¤ ìŒë‘¥ì´ì„ì„ ì•”ì‹œí•˜ê¸°',pts:2},
    {text:'ì „í˜€ ë‹¤ë¥¸ ì‹œëŒ€(ê³¼ê±°/ë¯¸ë˜)ë¡œ ê°‘ìê¸° ì´ë™í•˜ê¸°',pts:2},
    {text:'ì£¼ì¸ê³µì´ ì‚¬ì‹¤ ìœ ëª…ì¸ì„ì„ ì•”ì‹œí•˜ê¸°',pts:2},
    {text:'ìœ ë ¹ì´ë‚˜ ê·€ì‹ ì´ ë“±ì¥í•˜ê²Œ í•˜ê¸°',pts:2},
  ],
  hard: [
    {text:'ì‚¬ë‘Â·ì—°ì•  ê´€ë ¨ ë‹¨ì–´ ì—†ì´ ë¡œë§¨ìŠ¤ ë¶„ìœ„ê¸° ì™„ì„±í•˜ê¸°',pts:3},
    {text:'ì£¼ì¸ê³µ ì´ë¦„ í•œ ë²ˆë„ ì“°ì§€ ì•Šê³  ì´ì•¼ê¸° ì´ëŒê¸°',pts:3},
    {text:'ì´ì•¼ê¸° ì†ì— ë˜ ë‹¤ë¥¸ ì´ì•¼ê¸° êµ¬ì¡° ë§Œë“¤ê¸° (ì•¡ìì†Œì„¤)',pts:3},
    {text:'ì£¼ì¸ê³µì´ ì´ì•¼ê¸°ê°€ ì†Œì„¤ì„ì„ ê¹¨ë‹«ê²Œ í•˜ê¸° (ë©”íƒ€í”½ì…˜)',pts:3},
    {text:'ëŒ€í™”ë¬¸ ì—†ì´ ì´ì•¼ê¸°ë¥¼ ì „ê°œí•˜ê¸°',pts:3},
    {text:'ëª¨ë“  ë¬¸ì¥ì„ ì˜ë¬¸í˜•ìœ¼ë¡œ ìœ ë„í•˜ê¸°',pts:3},
  ]
};

const GENRES = [
  {name:'ëˆˆë¬¼ ë‚˜ëŠ” ì²«ì‚¬ë‘',emoji:'ğŸ’”',
   opening:'ê·¸ë‚  ë²„ìŠ¤ ì •ë¥˜ì¥ì—ì„œ ì²˜ìŒ ê·¸ ì‚¬ëŒì„ ë´¤ì„ ë•Œ, ë‚˜ëŠ” ì•„ë¬´ê²ƒë„ ëª¨ë¥¸ ì²™í–ˆë‹¤.',
   goal:'ì²«ì‚¬ë‘ì˜ ì„¤ë ˆì„ê³¼ ì•„ë ¨í•¨ì„ ë‹´ì€ ê°ë™ì ì¸ ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•˜ì„¸ìš”.'},
  {name:'ê¸´ì¥ê° ë„˜ì¹˜ëŠ” ìŠ¤ë¦´ëŸ¬',emoji:'ğŸ”ª',
   opening:'ë¬¸ì´ ì ê²¨ ìˆì—ˆë‹¤. ë¶„ëª…íˆ ë‚´ê°€ ì ê·¸ì§€ ì•Šì€ ë¬¸ì´.',
   goal:'ëê¹Œì§€ ê¸´ì¥ê°ì„ ìœ ì§€í•˜ë©° ë°˜ì „ì´ ìˆëŠ” ìŠ¤ë¦´ëŸ¬ë¥¼ ì™„ì„±í•˜ì„¸ìš”.'},
  {name:'í›ˆí›ˆí•œ ìš°ì • ì´ì•¼ê¸°',emoji:'ğŸ¤',
   opening:'10ë…„ ë§Œì— ì—°ë½ì´ ì˜¨ ë²ˆí˜¸ë¥¼ ë³´ë©°, ë‚˜ëŠ” í•œì°¸ì„ ë§ì„¤ì˜€ë‹¤.',
   goal:'ì˜¤ë˜ëœ ìš°ì •ì˜ ë”°ëœ»í•¨ì´ ëŠê»´ì§€ëŠ” ê°ë™ì ì¸ ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•˜ì„¸ìš”.'},
  {name:'ì½”ë¯¹ ì¢Œì¶©ìš°ëŒ ì—¬í–‰ê¸°',emoji:'âœˆï¸',
   opening:'ë¹„í–‰ê¸° í‘œë¥¼ ëŠê³  ë‚˜ì„œì•¼ ì•Œì•˜ë‹¤. ë‚˜ëŠ” ì—¬ê¶Œì´ ì—†ì—ˆë‹¤.',
   goal:'ì›ƒê¸°ê³  í™©ë‹¹í•œ ì‚¬ê±´ì´ ì—°ì†ìœ¼ë¡œ ì¼ì–´ë‚˜ëŠ” ì—¬í–‰ê¸°ë¥¼ ì™„ì„±í•˜ì„¸ìš”.'},
  {name:'ë¬´ì„œìš´ ê·€ì‹  ì´ì•¼ê¸°',emoji:'ğŸ‘»',
   opening:'ì´ì‚¬ ì²«ë‚  ë°¤, ì˜†ë°©ì—ì„œ ì•„ë¬´ë„ ì—†ëŠ”ë° ë°œì†Œë¦¬ê°€ ë“¤ë ¸ë‹¤.',
   goal:'ì†Œë¦„ ë‹ëŠ” ê³µí¬ ë¶„ìœ„ê¸°ë¥¼ ëê¹Œì§€ ìœ ì§€í•˜ë©° ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•˜ì„¸ìš”.'},
  {name:'ë‹¬ë‹¬í•œ ì§ì¥ ë¡œë§¨ìŠ¤',emoji:'ğŸ’¼',
   opening:'ìƒˆë²½ 2ì‹œ, ì•¼ê·¼ ì¤‘ì¸ ì‚¬ë¬´ì‹¤ì—ì„œ ê·¸ ì‚¬ëŒê³¼ ëˆˆì´ ë§ˆì£¼ì³¤ë‹¤.',
   goal:'ì§ì¥ì—ì„œ ì‹œì‘ë˜ëŠ” ì„¤ë ˆëŠ” ë¡œë§¨ìŠ¤ ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•˜ì„¸ìš”.'},
  {name:'í†µì¾Œí•œ ë³µìˆ˜ê·¹',emoji:'ğŸ˜¤',
   opening:'3ë…„ ì „ ê·¸ ì¼ì„ ìŠì§€ ì•Šì•˜ë‹¤. ì´ì œ ë•Œê°€ ëë‹¤.',
   goal:'í†µì¾Œí•˜ê³  ì‹œì›í•œ ë³µìˆ˜ ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•˜ì„¸ìš”.'},
  {name:'ë”°ëœ»í•œ ê°€ì¡± ì´ì•¼ê¸°',emoji:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',
   opening:'ì—„ë§ˆê°€ ë³´ë‚¸ ë¬¸ìì—ëŠ” ë”± ë‘ ê¸€ìë§Œ ìˆì—ˆë‹¤. "ë°¥ ë¨¹ì–´."',
   goal:'ê°€ì¡±ì˜ ì‚¬ë‘ê³¼ ë”°ëœ»í•¨ì´ ëŠê»´ì§€ëŠ” ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•˜ì„¸ìš”.'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let db = null;
let roomRef = null;
let roomListener = null;

const S = {
  uid: null, name: 'ìµëª…', emoji: 'ğŸ“',
  roomCode: null, isHost: false,
  role: null, mission: null, genre: null,
  settings: {turns:2, timer:60, view:'sentence'},
  myVote1: null, myVote2: null,
  roleConfirmed: false,
  timerInterval: null,
  ttsUtterance: null,
  gameData: null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFirebase() {
  const raw = document.getElementById('fbConfigInput').value.trim();
  let cfg;
  try {
    cfg = JSON.parse(raw);
  } catch(e) {
    document.getElementById('fbError').textContent = 'âŒ JSON í˜•ì‹ì´ ë§ì§€ ì•Šì•„ìš”. ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”.';
    return;
  }
  if (!cfg.databaseURL) {
    document.getElementById('fbError').textContent = 'âŒ databaseURLì´ ì—†ì–´ìš”. Realtime Databaseë¥¼ í™œì„±í™”í–ˆë‚˜ìš”?';
    return;
  }
  try {
    if (!firebase.apps.length) firebase.initializeApp(cfg);
    db = firebase.database();
    db.ref('.info/connected').once('value', snap => {
      localStorage.setItem('fbConfig', raw);
      show('s-home');
    }).catch(()=>{
      document.getElementById('fbError').textContent = 'âŒ ì—°ê²° ì‹¤íŒ¨. Firebase ì„¤ì •ì„ ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”.';
    });
  } catch(e) {
    document.getElementById('fbError').textContent = 'âŒ ' + e.message;
  }
}

function tryAutoInit() {
  const saved = localStorage.getItem('fbConfig');
  if (!saved) { show('s-setup'); return; }
  try {
    const cfg = JSON.parse(saved);
    if (!firebase.apps.length) firebase.initializeApp(cfg);
    db = firebase.database();
    show('s-home');
  } catch(e) { show('s-setup'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function show(id) {
  document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));
  document.getElementById(id).classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectEmoji(el) {
  document.querySelectorAll('.emoji-opt').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
  S.emoji = el.dataset.e;
}

function getMyName() {
  return document.getElementById('myName').value.trim() || 'ìµëª…' + Math.floor(Math.random()*1000);
}

function genUID() {
  return Math.random().toString(36).slice(2,10) + Date.now().toString(36);
}

function genCode() {
  const chars = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
  return Array.from({length:6},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

async function createRoom() {
  S.uid = S.uid || localStorage.getItem('uid') || genUID();
  localStorage.setItem('uid', S.uid);
  S.name = getMyName();
  S.isHost = true;

  const code = genCode();
  S.roomCode = code;
  roomRef = db.ref('rooms/' + code);

  await roomRef.set({
    host: S.uid,
    status: 'lobby',
    settings: {turns:2, timer:60, view:'sentence'},
    players: {
      [S.uid]: {name:S.name, emoji:S.emoji, score:0, connected:true}
    },
    createdAt: Date.now()
  });

  listenRoom();
  show('s-lobby');
}

async function joinRoom() {
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  if (code.length !== 6) { toast('ë°© ì½”ë“œëŠ” 6ìë¦¬ì˜ˆìš”!'); return; }

  S.uid = S.uid || localStorage.getItem('uid') || genUID();
  localStorage.setItem('uid', S.uid);
  S.name = getMyName();
  S.isHost = false;
  S.roomCode = code;
  roomRef = db.ref('rooms/' + code);

  const snap = await roomRef.once('value');
  if (!snap.exists()) { toast('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš” ğŸ¤”'); return; }
  const data = snap.val();
  if (data.status !== 'lobby') { toast('ì´ë¯¸ ê²Œì„ì´ ì‹œì‘ëœ ë°©ì´ì—ìš”!'); return; }

  const playerCount = Object.keys(data.players||{}).length;
  if (playerCount >= 8) { toast('ë°©ì´ ê½‰ ì°¼ì–´ìš”! (ìµœëŒ€ 8ëª…)'); return; }

  await roomRef.child('players/' + S.uid).set({
    name:S.name, emoji:S.emoji, score:0, connected:true
  });

  listenRoom();
  show('s-lobby');
}

function leaveRoom() {
  if (roomRef) {
    roomRef.child('players/' + S.uid).remove();
    if (roomListener) { roomRef.off('value', roomListener); roomListener = null; }
    roomRef = null;
  }
  S.roomCode = null; S.isHost = false;
  show('s-home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSetting(el) {
  if (!S.isHost) return;
  const k = el.dataset.k, v = el.dataset.v;
  document.querySelectorAll(`[data-k="${k}"]`).forEach(e=>e.classList.remove('on'));
  el.classList.add('on');
  const val = isNaN(v) ? v : Number(v);
  roomRef.child('settings/' + k).set(val);
}

function renderLobby(data) {
  document.getElementById('lobbyCode').textContent = S.roomCode;
  const players = data.players || {};
  const hostId = data.host;

  let html = '';
  Object.entries(players).forEach(([uid, p]) => {
    const isHost = uid === hostId;
    html += `<div class="player-item">
      <div class="player-emoji">${p.emoji||'ğŸ“'}</div>
      <div class="player-name">${p.name}${isHost?'':''}</div>
      ${isHost ? '<div class="host-badge">ë°©ì¥</div>' : ''}
    </div>`;
  });
  document.getElementById('playerList').innerHTML = html;

  const cnt = Object.keys(players).length;
  const isHost = data.host === S.uid;
  document.getElementById('startBtn').classList.toggle('hidden', !isHost);
  document.getElementById('waitingForHost').classList.toggle('hidden', isHost);
  document.getElementById('startBtn').textContent =
    cnt < 2 ? `ğŸ² ê²Œì„ ì‹œì‘! (ìµœì†Œ 2ëª…, í˜„ì¬ ${cnt}ëª…)` : `ğŸ² ê²Œì„ ì‹œì‘! (${cnt}ëª…)`;
  document.getElementById('startBtn').disabled = cnt < 2;

  // sync settings display
  const settings = data.settings || {};
  if (settings.turns) {
    document.querySelectorAll('[data-k="turns"]').forEach(e=>e.classList.remove('on'));
    document.querySelector(`[data-k="turns"][data-v="${settings.turns}"]`)?.classList.add('on');
  }
  if (settings.timer !== undefined) {
    document.querySelectorAll('[data-k="timer"]').forEach(e=>e.classList.remove('on'));
    document.querySelector(`[data-k="timer"][data-v="${settings.timer}"]`)?.classList.add('on');
  }
  if (settings.view) {
    document.querySelectorAll('[data-k="view"]').forEach(e=>e.classList.remove('on'));
    document.querySelector(`[data-k="view"][data-v="${settings.view}"]`)?.classList.add('on');
  }
  if (!isHost) {
    document.getElementById('settingsBox').style.opacity = '0.6';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startGame() {
  const snap = await roomRef.once('value');
  const data = snap.val();
  const players = data.players || {};
  const uids = Object.keys(players);
  if (uids.length < 2) { toast('ìµœì†Œ 2ëª…ì´ í•„ìš”í•´ìš”!'); return; }

  // Shuffle
  const shuffled = [...uids].sort(()=>Math.random()-.5);
  const spyIdx = Math.floor(Math.random() * uids.length);
  const spyUid = shuffled[spyIdx];

  // Pick mission
  const pool = Math.random() < .5 ? MISSIONS.easy : (Math.random() < .7 ? MISSIONS.medium : MISSIONS.hard);
  const mission = pool[Math.floor(Math.random() * pool.length)];

  // Pick genre
  const genre = GENRES[Math.floor(Math.random() * GENRES.length)];

  // Build turn order (each player repeats)
  const settings = data.settings || {turns:2, timer:60, view:'sentence'};
  let turnOrder = [];
  for (let i=0; i<settings.turns; i++) turnOrder = turnOrder.concat([...shuffled]);

  await roomRef.update({
    status: 'role_reveal',
    spy: spyUid,
    mission: mission,
    genre: genre,
    turnOrder: turnOrder,
    currentTurnIdx: 0,
    sentences: [{uid:'__system', text: genre.opening, name:'[ì²« ë¬¸ì¥]'}],
    confirmedRoles: {},
    settings: settings,
    nominations: {},
    accused: null,
    defenseText: '',
    finalVotes: {},
    result: null,
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROLE REVEAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRole(data) {
  const isSpy = data.spy === S.uid;
  S.role = isSpy ? 'spy' : 'citizen';
  S.mission = isSpy ? data.mission : null;
  S.genre = data.genre;

  document.getElementById('roleGenreName').textContent = `${data.genre.emoji} ${data.genre.name}`;

  const front = document.getElementById('cardFront');
  front.className = 'card-face card-front ' + S.role;
  document.getElementById('roleIcon').textContent = isSpy ? 'ğŸ•µï¸' : 'ğŸ“';
  document.getElementById('roleName').textContent = isSpy ? 'ìŠ¤íŒŒì´' : 'ì‹œë¯¼ ì‘ê°€';
  document.getElementById('roleDesc').textContent = isSpy
    ? 'ë“¤í‚¤ì§€ ì•Šê³  ë¹„ë°€ ë¯¸ì…˜ì„ ìˆ˜í–‰í•˜ì„¸ìš”!'
    : 'ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•˜ê³  ìŠ¤íŒŒì´ë¥¼ ì°¾ìœ¼ì„¸ìš”!';

  if (isSpy && data.mission) {
    document.getElementById('missionBox').style.display = 'block';
    document.getElementById('missionText').textContent = data.mission.text;
    document.getElementById('missionPts').textContent =
      `ì„±ê³µ ì‹œ +${data.mission.pts}ì  ì¶”ê°€ ë³´ë„ˆìŠ¤`;
  } else {
    document.getElementById('missionBox').style.display = 'none';
  }

  const confirmed = data.confirmedRoles || {};
  const total = Object.keys(data.players||{}).length;
  const done = Object.keys(confirmed).length;
  document.getElementById('roleWaiting').textContent =
    S.roleConfirmed ? `${done}/${total}ëª… í™•ì¸ ì™„ë£Œ...` : '';
}

function flipCard() {
  const card = document.getElementById('roleCard');
  if (!card.classList.contains('flipped')) {
    card.classList.add('flipped');
    document.getElementById('tapHint').style.display = 'none';
    document.getElementById('roleOkBtn').style.display = 'block';
  }
}

async function confirmRole() {
  S.roleConfirmed = true;
  document.getElementById('roleOkBtn').disabled = true;
  document.getElementById('roleOkBtn').textContent = 'âœ… í™•ì¸ ì™„ë£Œ!';
  await roomRef.child('confirmedRoles/' + S.uid).set(true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENRE REVEAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGenre(data) {
  const g = data.genre;
  document.getElementById('genrePill').textContent = 'ğŸ“š ì´ë²ˆ ë¼ìš´ë“œ ì¥ë¥´';
  document.getElementById('genreEmoji').textContent = g.emoji;
  document.getElementById('genreTitle').textContent = g.name;
  document.getElementById('openingBox').textContent = g.opening;
  document.getElementById('goalBox').innerHTML = `<b>ì‹œë¯¼ ëª©í‘œ:</b> ${g.goal}`;
  document.getElementById('genreStartBtn').classList.toggle('hidden', data.host !== S.uid);
}

async function beginWriting() {
  await roomRef.update({status:'writing', timerStart: Date.now()});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WRITING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWriting(data) {
  const turnOrder = data.turnOrder || [];
  const idx = data.currentTurnIdx || 0;
  const currentUid = turnOrder[idx];
  const isMyTurn = currentUid === S.uid;
  const players = data.players || {};
  const settings = data.settings || {};
  const sentences = data.sentences || [];
  const total = turnOrder.length;

  document.getElementById('writingProgress').style.width = `${(idx/total)*100}%`;
  document.getElementById('waitProgress').style.width = `${(idx/total)*100}%`;
  document.getElementById('waitTurnInfo').textContent = `ì§„í–‰ ${idx}/${total} í„´`;

  const myView = document.getElementById('myTurnView');
  const waitView = document.getElementById('waitingView');

  if (isMyTurn) {
    myView.style.display = 'flex';
    waitView.style.display = 'none';
    document.getElementById('writingTurnSub').textContent = `${idx+1}ë²ˆì§¸ ë¬¸ì¥`;

    // Limited view
    const viewMode = settings.view || 'sentence';
    let limited = '';
    if (sentences.length > 0) {
      const lastSent = sentences[sentences.length-1];
      if (viewMode === 'sentence') {
        limited = lastSent.text;
        document.getElementById('viewModeLabel').textContent = 'ë§ˆì§€ë§‰ ë¬¸ì¥';
      } else if (viewMode === 'chars') {
        limited = '...' + lastSent.text.slice(-15);
        document.getElementById('viewModeLabel').textContent = 'ë§ˆì§€ë§‰ 15ê¸€ìë§Œ';
      } else {
        limited = sentences.map(s=>s.text).join(' ');
        document.getElementById('viewModeLabel').textContent = 'ì „ì²´ ë³´ê¸°';
      }
    }
    document.getElementById('limitedView').textContent = limited;

    // Timer
    const timerSec = settings.timer || 0;
    startWritingTimer(timerSec, data.timerStart);
  } else {
    myView.style.display = 'none';
    waitView.style.display = 'flex';
    const currentPlayer = players[currentUid];
    document.getElementById('waitingName').textContent =
      (currentPlayer?.emoji||'ğŸ“') + ' ' + (currentPlayer?.name||'ëˆ„êµ°ê°€') + 'ì˜ ì°¨ë¡€';

    const timerSec = settings.timer || 0;
    startWaitTimer(timerSec, data.timerStart);
  }
}

let timerInterval = null;
let waitTimerInterval = null;

function startWritingTimer(sec, startTs) {
  clearInterval(timerInterval);
  const ring = document.getElementById('timerCircle');
  const num = document.getElementById('timerNum');
  const btn = document.getElementById('submitBtn');

  if (!sec) {
    ring.style.strokeDashoffset = '0';
    num.textContent = 'âˆ';
    btn.disabled = false;
    return;
  }

  function tick() {
    const elapsed = (Date.now() - startTs) / 1000;
    const left = Math.max(0, sec - elapsed);
    const pct = left / sec;
    ring.style.strokeDashoffset = String(157 * (1 - pct));
    ring.style.stroke = left < 10 ? 'var(--red)' : 'var(--accent)';
    num.textContent = Math.ceil(left);
    num.style.color = left < 10 ? 'var(--red)' : 'var(--accent)';
    btn.disabled = false;

    if (left <= 0) {
      clearInterval(timerInterval);
      autoSubmit();
    }
  }
  tick();
  timerInterval = setInterval(tick, 500);
}

function startWaitTimer(sec, startTs) {
  clearInterval(waitTimerInterval);
  const ring = document.getElementById('waitTimerCircle');
  const num = document.getElementById('waitTimerNum');

  if (!sec) { num.textContent = 'âˆ'; return; }

  function tick() {
    const elapsed = (Date.now() - startTs) / 1000;
    const left = Math.max(0, sec - elapsed);
    const pct = left / sec;
    ring.style.strokeDashoffset = String(157 * (1 - pct));
    ring.style.stroke = left < 10 ? 'var(--red)' : 'var(--accent)';
    num.textContent = Math.ceil(left);
  }
  tick();
  waitTimerInterval = setInterval(tick, 500);
}

function updateCharCount() {
  const v = document.getElementById('writeInput').value;
  document.getElementById('charCount').textContent = v.length;
}

async function autoSubmit() {
  const v = document.getElementById('writeInput').value.trim();
  await doSubmitSentence(v || '(ì‹œê°„ ì´ˆê³¼)');
}

async function submitSentence() {
  const v = document.getElementById('writeInput').value.trim();
  if (!v) { toast('ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
  clearInterval(timerInterval);
  document.getElementById('submitBtn').disabled = true;
  await doSubmitSentence(v);
}

async function doSubmitSentence(text) {
  const snap = await roomRef.once('value');
  const data = snap.val();
  const turnOrder = data.turnOrder || [];
  const idx = data.currentTurnIdx || 0;
  const nextIdx = idx + 1;
  const sentences = data.sentences || [];

  sentences.push({uid: S.uid, name: S.name, emoji: S.emoji, text: text});

  if (nextIdx >= turnOrder.length) {
    await roomRef.update({sentences, status:'narrating', currentTurnIdx: nextIdx});
  } else {
    await roomRef.update({sentences, currentTurnIdx: nextIdx, timerStart: Date.now()});
  }
  document.getElementById('writeInput').value = '';
  document.getElementById('charCount').textContent = '0';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NARRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNarration(data) {
  const sentences = data.sentences || [];
  const genre = data.genre || {};
  document.getElementById('storyTitleDisplay').textContent =
    `${genre.emoji||'ğŸ“–'} ì˜¤ëŠ˜ì˜ ë§ì‘`;
  document.getElementById('storyMeta').textContent =
    `ì´ ${sentences.length}ê°œ ë¬¸ì¥ Â· ì¥ë¥´: ${genre.name||''}`;

  let html = '';
  sentences.forEach((s, i) => {
    const isSystem = s.uid === '__system';
    html += `<div class="sentence-card" id="sc-${i}">
      <div class="sentence-text">${s.text}</div>
      <div class="sentence-author">${isSystem ? 'ğŸ“– ì²« ë¬¸ì¥' : (s.emoji+' '+s.name)}</div>
    </div>`;
  });
  document.getElementById('storyScroll').innerHTML = html;
  document.getElementById('goVoteBtn').classList.toggle('hidden', data.host !== S.uid);
}

let ttsQueue = [];
let ttsIdx = 0;

function startTTS() {
  if (!('speechSynthesis' in window)) { toast('ì´ ë¸Œë¼ìš°ì €ëŠ” TTSë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”'); return; }
  stopTTS();
  const cards = document.querySelectorAll('.sentence-card');
  ttsQueue = Array.from(cards).map((c,i)=>({
    text: c.querySelector('.sentence-text').textContent,
    idx: i
  }));
  ttsIdx = 0;
  document.getElementById('ttsPlayBtn').classList.add('playing');
  document.getElementById('ttsPlayBtn').textContent = 'ğŸ”Š ë‚­ë… ì¤‘...';
  speakNext();
}

function speakNext() {
  if (ttsIdx >= ttsQueue.length) {
    stopTTS(); return;
  }
  const item = ttsQueue[ttsIdx];
  document.querySelectorAll('.sentence-card').forEach(c=>c.classList.remove('speaking'));
  document.getElementById('sc-' + item.idx)?.classList.add('speaking');
  document.getElementById('sc-' + item.idx)?.scrollIntoView({behavior:'smooth',block:'center'});

  const u = new SpeechSynthesisUtterance(item.text);
  u.lang = 'ko-KR'; u.rate = 0.9; u.pitch = 0.95;
  u.onend = () => { ttsIdx++; setTimeout(speakNext, 400); };
  u.onerror = () => { ttsIdx++; speakNext(); };
  speechSynthesis.speak(u);
}

function stopTTS() {
  speechSynthesis.cancel();
  document.querySelectorAll('.sentence-card').forEach(c=>c.classList.remove('speaking'));
  document.getElementById('ttsPlayBtn').classList.remove('playing');
  document.getElementById('ttsPlayBtn').textContent = 'ğŸ”Š ë‚­ë… ì‹œì‘';
}

async function goToVote() {
  stopTTS();
  await roomRef.update({status:'vote1', nominations:{}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOTE 1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderVote1(data) {
  const players = data.players || {};
  const noms = data.nominations || {};

  let html = '';
  Object.entries(players).forEach(([uid, p]) => {
    if (uid === S.uid) return;
    const selected = S.myVote1 === uid;
    const cnt = Object.values(noms).filter(v=>v===uid).length;
    html += `<div class="vote-item${selected?' selected':''}" onclick="selectVote1('${uid}')">
      <div class="vote-item-emoji">${p.emoji||'ğŸ“'}</div>
      <div class="vote-item-name">${p.name}</div>
      <div style="font-size:.75rem;color:var(--muted)">${cnt > 0 ? cnt+'í‘œ' : ''}</div>
      <div class="vote-item-check">${selected ? 'ğŸ¯' : ''}</div>
    </div>`;
  });
  document.getElementById('voteList').innerHTML = html;

  const voted = Object.keys(noms).length;
  const total = Object.keys(players).length;
  document.getElementById('vote1Status').textContent = `${voted}/${total}ëª… íˆ¬í‘œ ì™„ë£Œ`;
  document.getElementById('submitVoteBtn').disabled = !S.myVote1;
}

function selectVote1(uid) {
  S.myVote1 = uid;
  document.querySelectorAll('.vote-item').forEach(el=>el.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  document.getElementById('submitVoteBtn').disabled = false;
}

async function submitVote1() {
  if (!S.myVote1) return;
  await roomRef.child('nominations/' + S.uid).set(S.myVote1);
  document.getElementById('submitVoteBtn').disabled = true;
  document.getElementById('submitVoteBtn').textContent = 'âœ… íˆ¬í‘œ ì™„ë£Œ!';

  // Check if all voted
  const snap = await roomRef.once('value');
  const data = snap.val();
  const noms = data.nominations || {};
  const players = data.players || {};
  if (Object.keys(noms).length >= Object.keys(players).length && data.host === S.uid) {
    // Tally
    const tally = {};
    Object.values(noms).forEach(uid => { tally[uid] = (tally[uid]||0)+1; });
    const accused = Object.entries(tally).sort((a,b)=>b[1]-a[1])[0]?.[0];
    await roomRef.update({status:'defense', accused, defenseText: ''});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFENSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDefense(data) {
  const accused = data.accused;
  const players = data.players || {};
  const p = players[accused] || {};
  const isAccused = accused === S.uid;

  document.getElementById('accusedName').textContent = (p.emoji||'ğŸ“') + ' ' + (p.name||'???');

  if (isAccused) {
    document.getElementById('defensPrompt').textContent = 'ë‹¹ì‹ ì´ ê°€ì¥ ë§ì€ ì§€ëª©ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.\n30ì´ˆ ì•ˆì— ì–µìš¸í•¨ì„ í˜¸ì†Œí•˜ì„¸ìš”!';
    document.getElementById('defenseInput').style.display = 'block';
    document.getElementById('defenseSpeech').style.display = 'none';
    document.getElementById('submitDefenseBtn').style.display = 'block';
    document.getElementById('defenseWaiting').textContent = '';
    startDefenseTimer(30);
  } else {
    document.getElementById('defensPrompt').textContent = `${p.name}ì´(ê°€) ë³€ë¡ í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;
    document.getElementById('defenseInput').style.display = 'none';
    document.getElementById('submitDefenseBtn').style.display = 'none';
    document.getElementById('defenseWaiting').textContent = 'ë³€ë¡ ì´ ëë‚˜ë©´ ìµœì¢… íˆ¬í‘œê°€ ì‹œì‘ë¼ìš”';
    const speech = data.defenseText || '';
    if (speech) {
      document.getElementById('defenseSpeech').style.display = 'block';
      document.getElementById('defenseSpeech').textContent = speech;
    }
  }
}

let defenseTimerInterval = null;
function startDefenseTimer(sec) {
  clearInterval(defenseTimerInterval);
  const ring = document.getElementById('defenseTimer');
  const num = document.getElementById('defenseTimerNum');
  let left = sec;

  function tick() {
    ring.style.strokeDashoffset = String(157 * (left/sec));
    num.textContent = left;
    if (left <= 0) { clearInterval(defenseTimerInterval); autoSubmitDefense(); }
    left--;
  }
  tick();
  defenseTimerInterval = setInterval(tick, 1000);
}

async function autoSubmitDefense() {
  const v = document.getElementById('defenseInput').value.trim() || '(í•  ë§ ì—†ìŒ)';
  await doSubmitDefense(v);
}

async function submitDefense() {
  const v = document.getElementById('defenseInput').value.trim() || '(í•  ë§ ì—†ìŒ)';
  clearInterval(defenseTimerInterval);
  await doSubmitDefense(v);
}

async function doSubmitDefense(text) {
  document.getElementById('submitDefenseBtn').disabled = true;
  await roomRef.update({defenseText: text, status:'vote2', finalVotes:{}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOTE 2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderVote2(data) {
  const accused = data.accused;
  const players = data.players || {};
  const p = players[accused] || {};
  const votes = data.finalVotes || {};
  const myVoted = votes[S.uid];
  const isAccused = accused === S.uid;

  document.getElementById('accusedInVote2').textContent = p.name || '???';
  document.getElementById('accusedEmoji2').textContent = p.emoji || 'ğŸ“';
  document.getElementById('accusedName2').textContent = p.name || '???';
  document.getElementById('defensePreview2').textContent = data.defenseText || 'â€”';

  const voted = Object.keys(votes).length;
  const total = Object.keys(players).length;
  document.getElementById('vote2Status').textContent =
    myVoted ? `${voted}/${total}ëª… íˆ¬í‘œ ì™„ë£Œ (ê²°ê³¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...)` : '';

  document.querySelectorAll('.execute-btn,.acquit-btn').forEach(b => {
    b.disabled = myVoted || isAccused;
  });
  if (isAccused) {
    document.getElementById('vote2Status').textContent = 'ë‹¹ì‹ ì— ëŒ€í•œ íˆ¬í‘œê°€ ì§„í–‰ ì¤‘ì´ì—ìš”...';
  }
}

async function submitVote2(choice) {
  S.myVote2 = choice;
  await roomRef.child('finalVotes/' + S.uid).set(choice);
  document.querySelectorAll('.execute-btn,.acquit-btn').forEach(b=>b.disabled=true);

  const snap = await roomRef.once('value');
  const data = snap.val();
  const votes = data.finalVotes || {};
  const players = data.players || {};
  if (Object.keys(votes).length >= Object.keys(players).length && data.host === S.uid) {
    await resolveVote2(data);
  }
}

async function resolveVote2(data) {
  const votes = data.finalVotes || {};
  const execute = Object.values(votes).filter(v=>v==='execute').length;
  const acquit = Object.values(votes).filter(v=>v==='acquit').length;
  const spyExecuted = execute > acquit;
  const accused = data.accused;
  const isSpyCaught = spyExecuted && accused === data.spy;
  const spyEscaped = !spyExecuted || (spyExecuted && accused !== data.spy);

  // Score calculation
  const players = data.players || {};
  const newScores = {};
  Object.keys(players).forEach(uid => {
    newScores[uid] = players[uid].score || 0;
  });

  const mission = data.mission || {};
  const missionSuccess = checkMissionSuccess(data);

  if (isSpyCaught) {
    // Citizens win
    Object.keys(players).forEach(uid => {
      if (uid !== data.spy) newScores[uid] = (newScores[uid]||0) + 2;
    });
  } else if (accused !== data.spy && spyExecuted) {
    // Wrong person executed (spy gets +2, victim gets nothing)
    newScores[data.spy] = (newScores[data.spy]||0) + 2;
  } else {
    // Spy escaped
    newScores[data.spy] = (newScores[data.spy]||0) + 2;
  }

  if (missionSuccess && !isSpyCaught) {
    newScores[data.spy] = (newScores[data.spy]||0) + (mission.pts||1);
  }

  // Update scores in players
  const updatedPlayers = {...players};
  Object.keys(updatedPlayers).forEach(uid => {
    updatedPlayers[uid] = {...updatedPlayers[uid], score: newScores[uid]};
  });

  const commentary = await getAICommentary(data, isSpyCaught, missionSuccess);

  await roomRef.update({
    status: 'result',
    players: updatedPlayers,
    result: {
      spyExecuted, accused,
      spyCaught: isSpyCaught,
      missionSuccess,
      commentary,
      executeVotes: execute,
      acquitVotes: acquit,
    }
  });
}

function checkMissionSuccess(data) {
  const sentences = (data.sentences||[]).map(s=>s.text).join(' ');
  const mission = data.mission;
  if (!mission) return false;
  const text = mission.text;
  if (text.includes('êµ­ë°¥')) return (sentences.match(/êµ­ë°¥/g)||[]).length >= 2;
  if (text.includes('ì¹˜í‚¨')) return sentences.includes('ì¹˜í‚¨');
  if (text.includes('ë¼ë©´')) return (sentences.match(/ë¼ë©´/g)||[]).length >= 2;
  if (text.includes('ì»¤í”¼')) return (sentences.match(/ì»¤í”¼/g)||[]).length >= 2;
  if (text.includes('ì™¸ê³„ì¸')) return sentences.includes('ì™¸ê³„ì¸');
  if (text.includes('ê¿ˆì´ì—ˆë‹¤')) return sentences.includes('ê¿ˆ');
  if (text.includes('ë¡œë´‡')) return sentences.includes('ë¡œë´‡');
  if (text.includes('ê³ ì–‘ì´')) return (sentences.match(/ê³ ì–‘ì´/g)||[]).length >= 2;
  // For others, default to host judgment (set randomly for now)
  return Math.random() > 0.5;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESULT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResult(data) {
  const result = data.result || {};
  const players = data.players || {};
  const spy = data.spy;
  const spyPlayer = players[spy] || {};
  const mission = data.mission || {};

  // Headline
  let headline = '';
  if (result.spyCaught) headline = 'ğŸ‰ ì‹œë¯¼ íŒ€ ìŠ¹ë¦¬! ìŠ¤íŒŒì´ë¥¼ ì¡ì•˜ìŠµë‹ˆë‹¤!';
  else if (result.accused !== spy) headline = 'ğŸ˜ˆ ìŠ¤íŒŒì´ ìŠ¹ë¦¬! ë¬´ê³ í•œ ì‹œë¯¼ì„ í¬ìƒì‹œì¼°ìŠµë‹ˆë‹¤!';
  else headline = 'ğŸ•µï¸ ìŠ¤íŒŒì´ íƒˆì¶œ ì„±ê³µ! ìŠ¤íŒŒì´ì˜ ëŒ€ìŠ¹ë¦¬!';
  document.getElementById('resultHeadline').textContent = headline;

  const revealCard = document.getElementById('revealCard');
  revealCard.className = 'reveal-card ' + (result.spyCaught ? 'citizens-won' : 'spy-won');
  document.getElementById('spyRevealEmoji').textContent = spyPlayer.emoji || 'ğŸ•µï¸';
  document.getElementById('spyRevealName').textContent = spyPlayer.name || '???';
  document.getElementById('missionRevealText').textContent = mission.text || 'â€”';
  const statusEl = document.getElementById('missionStatus');
  if (result.missionSuccess && !result.spyCaught) {
    statusEl.textContent = 'âœ… ë¯¸ì…˜ ì„±ê³µ! +' + (mission.pts||1) + 'ì  íšë“';
    statusEl.className = 'mission-result-status success';
  } else {
    statusEl.textContent = 'âŒ ë¯¸ì…˜ ì‹¤íŒ¨ ë˜ëŠ” ë“¤ì¼œì„œ ë¬´íš¨';
    statusEl.className = 'mission-result-status fail';
  }

  // Scores
  const sorted = Object.entries(players).sort((a,b)=>(b[1].score||0)-(a[1].score||0));
  let shtml = '';
  sorted.forEach(([uid, p], i) => {
    const isSpy = uid === spy;
    shtml += `<div class="score-row">
      <div style="font-size:.9rem;font-weight:700;color:var(--muted);width:20px">${i+1}</div>
      <div class="score-emoji">${p.emoji||'ğŸ“'}</div>
      <div class="score-name">${p.name}${isSpy?' ğŸ•µï¸':''}</div>
      <div class="score-pts">${p.score||0}ì </div>
    </div>`;
  });
  document.getElementById('scoresBox').innerHTML = shtml;

  // AI commentary
  document.getElementById('aiCommentary').textContent =
    result.commentary || 'í‰ë¡ ê°€ê°€ ì ì‹œ ìë¦¬ë¥¼ ë¹„ì› ìŠµë‹ˆë‹¤...';

  document.getElementById('replayBtn').classList.toggle('hidden', data.host !== S.uid);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI COMMENTARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getAICommentary(data, spyCaught, missionSuccess) {
  const sentences = (data.sentences||[]).map(s=>s.text).join(' ');
  const genre = data.genre?.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì¥ë¥´';
  const spyName = data.players?.[data.spy]?.name || '???';

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514', max_tokens:300,
        messages:[{role:'user', content:
          `ë‹¹ì‹ ì€ ê¶Œìœ„ì ì¸ ë¬¸í•™ í‰ë¡ ê°€ "ê¹€ì„¸ì¤€"ì…ë‹ˆë‹¤. ì•„ë˜ ì†Œì„¤ì„ ì—„ê²©í•˜ê²Œ í‰ë¡ í•´ì£¼ì„¸ìš”. ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ, 3~4ë¬¸ì¥ìœ¼ë¡œ, ì§„ì§€í•œ ì²™í•˜ë©´ì„œ ì€ê·¼íˆ ë°•í•˜ê²Œ í‰ê°€í•˜ê³  ë³„ì (â˜… 5ê°œ ì¤‘)ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”. ë„ˆë¬´ ê¸¸ê²Œ ì“°ì§€ ë§ˆì„¸ìš”.
          
ì¥ë¥´: ${genre}
ì†Œì„¤ ë‚´ìš©: ${sentences.slice(0,400)}
ê²°ê³¼: ìŠ¤íŒŒì´(${spyName})ëŠ” ${spyCaught?'ì²´í¬ë¨':'íƒˆì¶œí•¨'}. ë¯¸ì…˜ì€ ${missionSuccess?'ì„±ê³µ':'ì‹¤íŒ¨'}.`
        }]
      })
    });
    const json = await res.json();
    return json.content?.[0]?.text || getFallbackCommentary();
  } catch(e) {
    return getFallbackCommentary();
  }
}

function getFallbackCommentary() {
  const comments = [
    'ì´ë²ˆ ì‘í’ˆì€ ê¸°ìŠ¹ì „ê²°ì´ ì•„ë‹Œ ê¸°ìŠ¹ê¸°ìŠ¹ê¸°ê¸°ì˜ êµ¬ì¡°ë¥¼ ì±„íƒí•˜ì—¬ ë…ìë¥¼ ê·¹ë„ì˜ í˜¼ë€ìœ¼ë¡œ ì´ëŒì—ˆìŠµë‹ˆë‹¤. ë¬¸í•™ì  ì‹¤í—˜ì´ë¼ ë¶€ë¥´ê¸°ì—” ë‹¤ì†Œ ë¬´ëª¨í•˜ê³ , ì‚¬ê³ ë¼ ë¶€ë¥´ê¸°ì—” ë„ˆë¬´ ë°˜ë³µì ì…ë‹ˆë‹¤. ê·¸ëŸ¼ì—ë„ ì§‘ë‹¨ ì°½ì‘ì˜ ìƒë™ê°ì€ ì¸ì •í•©ë‹ˆë‹¤. â˜…â˜…â˜†â˜†â˜†',
    'ì¤„ê±°ë¦¬ë¥¼ ìš”ì•½í•˜ë ¤ í–ˆìœ¼ë‚˜ ë¶ˆê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤. ì•„ë§ˆë„ ì‘ê°€ë“¤ ì¤‘ ëˆ„êµ°ê°€ê°€ ì²˜ìŒë¶€í„° í¬ê¸°í–ˆê±°ë‚˜, ì•„ë‹ˆë©´ ëª¨ë‘ê°€ ì„œë¡œ ë‹¤ë¥¸ ì†Œì„¤ì„ ì“´ ê²ƒìœ¼ë¡œ ì¶”ì •ë©ë‹ˆë‹¤. ë…ì°½ì„± ë©´ì—ì„œë§Œí¼ì€ ë†’ì´ í‰ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. â˜…â˜†â˜†â˜†â˜†',
    'ë³¸ ì‘í’ˆì€ í˜„ëŒ€ í•œêµ­ ë¬¸í•™ì˜ ìƒˆë¡œìš´ ì§€í‰ì„ ì—´ì—ˆë‹¤ê³  í‰ê°€í•˜ê¸°ì—” ë¬´ë¦¬ê°€ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ì •ë„ ìˆ˜ì¤€ì˜ í˜¼ëˆì„ ì´ë ‡ê²Œ ì§§ì€ ì‹œê°„ì— ë§Œë“¤ì–´ëƒˆë‹¤ëŠ” ì ì€ ë‚˜ë¦„ ê°íƒ„ìŠ¤ëŸ½ìŠµë‹ˆë‹¤. â˜…â˜…â˜…â˜†â˜†',
  ];
  return comments[Math.floor(Math.random() * comments.length)];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPLAY / HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function replayGame() {
  // Reset game state but keep players and scores
  S.myVote1 = null; S.myVote2 = null; S.roleConfirmed = false;
  await roomRef.update({
    status: 'lobby', spy:null, mission:null, genre:null,
    turnOrder:null, currentTurnIdx:0, sentences:null,
    confirmedRoles:null, nominations:null, accused:null,
    defenseText:'', finalVotes:null, result:null
  });
}

function goHomeFromResult() {
  if (roomListener) { roomRef.off('value', roomListener); roomListener = null; }
  roomRef = null; S.roomCode = null; S.isHost = false;
  S.myVote1 = null; S.myVote2 = null; S.roleConfirmed = false;
  show('s-home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN LISTENER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listenRoom() {
  if (roomListener) { roomRef.off('value', roomListener); }
  roomListener = roomRef.on('value', snap => {
    if (!snap.exists()) { toast('ë°©ì´ ì‚¬ë¼ì¡Œì–´ìš”!'); show('s-home'); return; }
    const data = snap.val();
    S.gameData = data;
    S.isHost = data.host === S.uid;

    // Check if player still in room
    if (!data.players?.[S.uid] && data.status !== 'lobby') return;

    switch(data.status) {
      case 'lobby':
        renderLobby(data);
        if (!document.getElementById('s-lobby').classList.contains('on')) show('s-lobby');
        break;
      case 'role_reveal':
        renderRole(data);
        show('s-role');
        // Check if all confirmed
        const confirmed = data.confirmedRoles || {};
        const total = Object.keys(data.players||{}).length;
        if (Object.keys(confirmed).length >= total && data.host === S.uid) {
          roomRef.update({status:'genre_reveal'});
        }
        break;
      case 'genre_reveal':
        renderGenre(data);
        show('s-genre');
        break;
      case 'writing':
        renderWriting(data);
        show('s-writing');
        break;
      case 'narrating':
        renderNarration(data);
        show('s-narration');
        break;
      case 'vote1':
        renderVote1(data);
        show('s-vote1');
        // Auto-advance if all voted
        const noms = data.nominations || {};
        const players = data.players || {};
        if (Object.keys(noms).length >= Object.keys(players).length && data.host === S.uid) {
          const tally = {};
          Object.values(noms).forEach(uid => { tally[uid] = (tally[uid]||0)+1; });
          const accused = Object.entries(tally).sort((a,b)=>b[1]-a[1])[0]?.[0];
          roomRef.update({status:'defense', accused, defenseText:''});
        }
        break;
      case 'defense':
        renderDefense(data);
        show('s-defense');
        break;
      case 'vote2':
        renderVote2(data);
        show('s-vote2');
        // Auto-advance if all voted
        const v2 = data.finalVotes || {};
        const p2 = data.players || {};
        if (Object.keys(v2).length >= Object.keys(p2).length && data.host === S.uid) {
          if (data.result === null || data.result === undefined) {
            resolveVote2(data);
          }
        }
        break;
      case 'result':
        renderResult(data);
        show('s-result');
        break;
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer = null;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', () => {
  S.uid = localStorage.getItem('uid') || null;
  tryAutoInit();
});
</script>
</body>
</html>
